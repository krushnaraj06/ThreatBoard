# ThreatBoard Vulnerability Management Backend

A robust Node.js + Express + MongoDB backend for managing and prioritizing vulnerabilities from various security scanners.

## Features

### üîç **Scanner Integration**
- **Multi-format Support**: JSON, XML, CSV scanner outputs
- **Auto-detection**: Automatically identifies scanner type (Nessus, OpenVAS, Nmap, Burp, Nikto)
- **Flexible Parsing**: Handles various scanner output formats and structures

### üöÄ **Vulnerability Enrichment**
- **NVD API Integration**: Fetches CVSS scores, descriptions, and metadata
- **CISA KEV Check**: Identifies known exploited vulnerabilities
- **Exploit Availability**: Checks Exploit-DB and GitHub for PoC exploits
- **Rate Limiting**: Prevents API abuse with intelligent throttling

### üìä **Contextual Prioritization**
- **Rule-based Scoring**: Uses CVSS base score (50%), exploit availability (+20), CISA KEV (+30), asset criticality (30%), internet exposure (+15)
- **Asset Context**: Considers asset criticality and internet exposure
- **Business Impact**: Factors in compliance requirements and business context

### üóÑÔ∏è **Data Management**
- **MongoDB Storage**: Scalable NoSQL database with optimized indexes
- **Deduplication**: Prevents duplicate CVE entries
- **Version Control**: Tracks changes and updates
- **Export Options**: JSON and CSV export functionality

### üîí **Security & Performance**
- **Helmet Security**: Comprehensive security headers
- **Rate Limiting**: Prevents abuse and DoS attacks
- **Input Validation**: Robust file and data validation
- **Compression**: Gzip compression for better performance
- **Logging**: Comprehensive request and error logging

## Technology Stack

- **Runtime**: Node.js 16+
- **Framework**: Express.js 4.18+
- **Database**: MongoDB 5.0+ with Mongoose ODM
- **File Processing**: Multer, xml2js, csv-parser
- **HTTP Client**: Axios for external API calls
- **Security**: Helmet, express-rate-limit, CORS
- **Utilities**: Compression, Morgan logging

## Project Structure

```
vulnerability-backend/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ vulnerabilityController.js    # Business logic and API handlers
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ Vulnerability.js              # MongoDB schema and methods
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ vulnerabilityRoutes.js        # Express routes and middleware
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ fileParser.js                 # Scanner output parsing
‚îÇ   ‚îî‚îÄ‚îÄ vulnerabilityEnrichment.js    # External API integration
‚îú‚îÄ‚îÄ uploads/                          # Temporary file storage
‚îú‚îÄ‚îÄ server.js                         # Main application entry point
‚îú‚îÄ‚îÄ package.json                      # Dependencies and scripts
‚îî‚îÄ‚îÄ README.md                         # This file
```

## Installation

### Prerequisites
- Node.js 16+ and npm
- MongoDB 5.0+ (local or Atlas)
- Git

### Setup

1. **Clone and navigate to the project**
   ```bash
   cd Threatbackend/vulnerability-backend
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Environment Configuration**
   Create a `.env` file based on `.env.example`:
   ```bash
   # Copy example file
   cp .env.example .env
   
   # Edit with your configuration
   nano .env
   ```

4. **MongoDB Setup**
   - **Local MongoDB**: Install and start MongoDB service
   - **MongoDB Atlas**: Create cluster and get connection string
   - Update `MONGODB_URI` in `.env`

5. **Start the server**
   ```bash
   # Development mode
   npm run dev
   
   # Production mode
   npm start
   ```

## API Endpoints

### File Upload
- `POST /api/upload` - Upload scanner output files

### Vulnerability Management
- `GET /api/vulnerabilities` - List vulnerabilities with filtering/pagination
- `GET /api/vulnerabilities/:id` - Get specific vulnerability
- `PUT /api/vulnerabilities/:id` - Update vulnerability
- `DELETE /api/vulnerabilities/:id` - Delete vulnerability
- `PUT /api/vulnerabilities/bulk` - Bulk update vulnerabilities

### Analytics & Reporting
- `GET /api/statistics` - Get vulnerability statistics
- `GET /api/latest` - Get latest CVEs
- `GET /api/export` - Export vulnerabilities (JSON/CSV)

### System
- `GET /health` - Health check
- `GET /` - API information

## Scanner Support

### Supported Formats
- **Nessus**: `.csv`, `.json` outputs
- **OpenVAS**: `.xml`, `.json` outputs  
- **Nmap**: `.xml` outputs with NSE scripts
- **Burp Suite**: `.xml` scan results
- **Nikto**: `.xml` scan outputs
- **Custom**: Generic JSON/CSV with flexible field mapping

### File Requirements
- **Size Limit**: 10MB maximum
- **Format**: JSON, XML, or CSV
- **Encoding**: UTF-8 recommended
- **Structure**: Must contain CVE identifiers or vulnerability data

## Priority Scoring Algorithm

The system calculates a priority score (0-100) using:

```
Priority Score = (CVSS Score / 10) √ó 50 + 
                Exploit Available (+20) + 
                CISA KEV (+30) + 
                Asset Criticality √ó 0.3 + 
                Internet Exposed (+15) + 
                Scanner Source Bonus (+5)
```

### Severity Mapping
- **Critical**: 90-100 points
- **High**: 70-89 points  
- **Medium**: 50-69 points
- **Low**: 30-49 points
- **Info**: 0-29 points

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Server port | 5000 |
| `NODE_ENV` | Environment mode | development |
| `MONGODB_URI` | MongoDB connection string | mongodb://localhost:27017/threatboard |
| `FRONTEND_URL` | Frontend URL for CORS | http://localhost:3000 |
| `RATE_LIMIT_MAX_REQUESTS` | Rate limit per 15 minutes | 100 |
| `MAX_FILE_SIZE` | Maximum file upload size | 10485760 (10MB) |

### Customization

The system can be customized by modifying:
- Priority scoring weights in `.env`
- Severity thresholds
- Scanner parsing logic in `services/fileParser.js`
- Enrichment sources in `services/vulnerabilityEnrichment.js`

## Development

### Running Tests
```bash
npm test
```

### Code Quality
```bash
# Linting (if ESLint is configured)
npm run lint

# Formatting (if Prettier is configured)
npm run format
```

### Database Operations
```bash
# Connect to MongoDB shell
mongosh

# Use database
use threatboard

# View collections
show collections

# Query vulnerabilities
db.vulnerabilities.find().limit(5)
```

## Deployment

### Production Considerations
1. **Environment Variables**: Set production values
2. **MongoDB**: Use production MongoDB instance/Atlas
3. **Security**: Enable HTTPS, set proper CORS origins
4. **Monitoring**: Add application monitoring and logging
5. **Backup**: Implement database backup strategy

### Docker Support
```dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 5000
CMD ["npm", "start"]
```

## Troubleshooting

### Common Issues

1. **MongoDB Connection Failed**
   - Check MongoDB service status
   - Verify connection string in `.env`
   - Ensure network access to MongoDB

2. **File Upload Errors**
   - Check file size (max 10MB)
   - Verify file format (JSON/XML/CSV)
   - Check uploads directory permissions

3. **API Rate Limiting**
   - Reduce request frequency
   - Implement client-side retry logic
   - Check rate limit configuration

4. **External API Failures**
   - Verify internet connectivity
   - Check API rate limits
   - Review error logs for specific failures

### Logs
- **Application logs**: Console output and Morgan logs
- **Error logs**: Global error handler output
- **Upload logs**: File processing and storage logs

## Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Support

For support and questions:
- Create an issue in the repository
- Check the troubleshooting section
- Review API documentation
- Contact the development team

---

**ThreatBoard Vulnerability Management** - Making security vulnerabilities manageable and actionable.
